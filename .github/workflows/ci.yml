name: Multi-Step Workflow

on:
  workflow_dispatch:
    inputs:
      ref_name:
        description: "The ref name to use"
        required: true
        default: "main"
      committer_name:
        description: "The committer name to use"
        required: true
        default: "Uniscore Dev"
  push:
    tags:
      - v*
env:
  LC_ALL: en_US.UTF-8
  LANG: en_US.UTF-8
  REF_NAME: ${{ github.event.inputs.ref_name }}
  COMMITTER_NAME: ${{ github.event.inputs.committer_name }}
  P12_PASSWORD: ${{ secrets.P12_PASSWORD }}
  GITLAB_TOKEN: ${{ secrets.GITLAB_TOKEN }}
  MAIN_REPO: ${{ secrets.MAIN_REPO }}
  TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
  TELEGRAM_GROUP_ID: ${{ vars.TELEGRAM_GROUP_ID }}
  TELEGRAM_TOPIC_ID: ${{ vars.TELEGRAM_TOPIC_ID }}
  GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
jobs:
  init:
    runs-on: macos-14
    outputs:
      matrix: ${{ steps.set-matrix.outputs.value }}
      message-information: ${{ steps.get-message-information.outputs.value }}
      env: ${{ steps.set-env.outputs.value }}
    steps:
      - name: Clone GitLab repository
        run: |
          git clone https://oauth2:$GITLAB_TOKEN@gitlab.com/unity1185445/uniscore-mobile.git
          cd uniscore-mobile
          git checkout $REF_NAME

      - name: Set matrix
        id: set-matrix
        run: |
          MATRIX="[{\"format\":\"IPA\",\"name\":\"macos-14\",\"platform\":\"IOS\"},{\"format\":\"APK\",\"name\":\"ubuntu-22.04\",\"platform\":\"ANDROID\"}]"
          if [[ "$REF_NAME" =~ "prod" ]]; then
            MATRIX="[{\"format\":\"IPA\",\"name\":\"macos-14\",\"platform\":\"IOS\"},{\"format\":\"APK\",\"name\":\"ubuntu-22.04\",\"platform\":\"ANDROID\"},{\"format\":\"AAB\",\"name\":\"ubuntu-22.04\",\"platform\":\"ANDROID\"}]"
          fi
          echo "value=$MATRIX" >> $GITHUB_OUTPUT

      - name: Set env
        id: set-env
        run: |
          ENV='dev'
          if [[ "$REF_NAME" =~ "prod" ]]; then
            ENV='prod'
          elif [[ "$REF_NAME" =~ "stag" ]]; then
            ENV='stag'
          elif [[ "$REF_NAME" =~ "beta" ]]; then
            ENV='beta'
          fi
          echo "value=$ENV" >> $GITHUB_OUTPUT

      - name: Generate message
        working-directory: uniscore-mobile
        id: get-message-information
        run: |
          source .github/scripts/utils.sh
          echo "value=$(get_message_information)" >> "$GITHUB_OUTPUT"
        timeout-minutes: 1
      - name: Log value
        run: |
          echo "tag-source: $REF_NAME"
          echo "matrix: ${{ steps.set-matrix.outputs.value }}"
          echo "env: ${{ steps.set-env.outputs.value }}"
      - name: Send telegram message
        uses: UniscoreDev/macos-telegram-action@main
        with:
          type: topic
          message: "ðŸŽ¬ - Báº¯t Ä‘áº§u build: ${{ steps.get-message-information.outputs.value }}\n- Thanh niÃªn áº¥n build ðŸ‘¨â€ðŸ’»: ${{ env.COMMITTER_NAME || 'Unknown' }}\n"

  prepare:
    name: Prepare ${{ matrix.format }}
    runs-on: ${{ matrix.name }}
    needs: [init]
    strategy:
      fail-fast: true
      matrix:
        include: ${{ fromJson(needs.init.outputs.matrix) }}
    steps:
      - name: Capture Job Start Time
        run: echo "JOB_START_TIME=$(date +%s)" >> $GITHUB_ENV

      - name: Clone the GitLab repository
        run: |
          git clone https://oauth2:$GITLAB_TOKEN@gitlab.com/unity1185445/uniscore-mobile.git
          cd uniscore-mobile
          git checkout $REF_NAME

      - name: Setup Node v20
        uses: actions/setup-node@v4
        with:
          node-version: "22.21.1"
      - name: Cache node_modules
        id: cache-node-modules
        uses: actions/cache@v4
        with:
          path: uniscore-mobile/node_modules
          key: ${{ matrix.platform }}-cache-node-modules-${{ hashFiles('uniscore-mobile/package.json') }}
          lookup-only: true
      - name: Run yarn install
        # uses: borales/actions-yarn@v5
        if: steps.cache-node-modules.outputs.cache-hit != 'true'
        run: |
          cd uniscore-mobile
          yarn install --network-concurrency 1

      - name: Run tests
        run: echo "Testing..."

      - name: Analyze Failure with AI
        if: ${{ failure() }}
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          # 1. Get the failed job logs (limit to last 200 lines)
          LOGS=$(gh run view ${{ github.run_id }} --log-failed | tail -n 200)
          
          # 2. Build Prompt
          PROMPT="HÃ£y phÃ¢n tÃ­ch cÃ¡c log lá»—i GitHub Action sau Ä‘Ã¢y vÃ  cung cáº¥p má»™t báº£n tÃ³m táº¯t ngáº¯n gá»n vá» nhá»¯ng gÃ¬ Ä‘Ã£ sai vÃ  cÃ¡ch kháº¯c phá»¥c báº±ng tiáº¿ng Viá»‡t. Giá»¯ ná»™i dung dÆ°á»›i 200 tá»«. Tráº£ vá» káº¿t quáº£ dÆ°á»›i dáº¡ng text thuáº§n tÃºy, khÃ´ng dÃ¹ng markdown quÃ¡ phá»©c táº¡p.\n\nLog:\n$LOGS"
          
          # 3. Build JSON payload using jq
          jq -n --arg prompt "$PROMPT" '{contents: [{parts: [{text: $prompt}]}]}' > payload.json

          # 4. Send to Gemini for analysis (3-tier fallback)
          ANALYSIS=$(curl -s -X POST "https://generativelanguage.googleapis.com/v1beta/models/gemini-flash-latest:generateContent?key=$GEMINI_API_KEY" \
            -H "Content-Type: application/json" \
            -d @payload.json | jq -r '.candidates[0].content.parts[0].text // empty')

          if [[ -z "$ANALYSIS" || "$ANALYSIS" == "null" ]]; then
            ANALYSIS=$(curl -s -X POST "https://generativelanguage.googleapis.com/v1beta/models/gemini-flash-lite-latest:generateContent?key=$GEMINI_API_KEY" \
              -H "Content-Type: application/json" \
              -d @payload.json | jq -r '.candidates[0].content.parts[0].text // empty')
          fi

          if [[ -z "$ANALYSIS" || "$ANALYSIS" == "null" ]]; then
            ANALYSIS=$(curl -s -X POST "https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash-lite:generateContent?key=$GEMINI_API_KEY" \
              -H "Content-Type: application/json" \
              -d @payload.json | jq -r '.candidates[0].content.parts[0].text // "KhÃ´ng thá»ƒ phÃ¢n tÃ­ch lá»—i lÃºc nÃ y."')
          fi
          
          # 5. Save analysis to a file
          echo "$ANALYSIS" > ai_analysis_prepare.txt

      - name: Send telegram message failure
        if: ${{ failure() }}
        uses: UniscoreDev/macos-telegram-action@main
        with:
          type: topic
          message: |
            ðŸ’¥ - Tháº¥t báº¡i rá»“i báº¡n hiá»n ${{ matrix.platform }}: ${{ needs.init.outputs.message-information }}
            
            ðŸ¤– **PhÃ¢n tÃ­ch AI:**
            $(cat ai_analysis_prepare.txt 2>/dev/null || echo "KhÃ´ng cÃ³ phÃ¢n tÃ­ch nÃ o.")

  deploy:
    name: Deployment ${{ matrix.format }}
    continue-on-error: true
    strategy:
      fail-fast: true
      matrix:
        include: ${{ fromJson(needs.init.outputs.matrix) }}
    runs-on: ${{ matrix.name }}
    needs: [init, prepare]
    timeout-minutes: 60
    env:
      START_TIME: ${{ github.event.repository.updated_at }} # Placeholder, will set actual start time in steps
    steps:
      - name: Free Disk Space (Ubuntu)
        if: matrix.platform == 'ANDROID'
        uses: jlumbroso/free-disk-space@v1.3.1
        with:
          tool-cache: false
          android: false
          dotnet: true
          haskell: true
          large-packages: true
          docker-images: true
          swap-storage: true

      - name: Set Start Time
        run: echo "JOB_START_TIME=$(date +%s)" >> $GITHUB_ENV

      # Step 3: Clone the GitLab repository manually using git
      - name: Clone GitLab repository
        run: |
          git clone https://oauth2:$GITLAB_TOKEN@gitlab.com/unity1185445/uniscore-mobile.git
          cd uniscore-mobile
          git checkout $REF_NAME

      # # Step 4: Move all files from the cloned GitLab repository to the root directory (./)
      # - name: Move files to root
      #   run: |
      #     mv uniscore-mobile/* ./
      #     mv uniscore-mobile/.[!.]* ./
      #     rm -rf uniscore-mobile
      - name: Setup ruby 3.1.4
        uses: ruby/setup-ruby@v1
        with:
          ruby-version: "3.3.4"
          bundler-cache: true
      - name: Bundle install
        working-directory: uniscore-mobile
        run: bundle install
      - name: Setup Node v20
        uses: actions/setup-node@v4
        with:
          node-version: "22.21.1"

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        if: matrix.platform == 'ANDROID'
        with:
          java-version: "17"
          distribution: "temurin"
          # cache: "gradle"

      - name: Setup Android SDK
        if: matrix.platform == 'ANDROID'
        uses: android-actions/setup-android@v3

      - name: Setup Android NDK
        uses: nttld/setup-ndk@v1
        if: matrix.platform == 'ANDROID'
        with:
          ndk-version: r26c

      - name: Setup cocoapods
        if: matrix.platform == 'IOS'
        uses: maxim-lobanov/setup-cocoapods@v1
        with:
          version: 1.16.2

      - name: Select Xcode
        if: matrix.platform == 'IOS'
        uses: maxim-lobanov/setup-xcode@v1
        with:
          xcode-version: "16.1.0"
      # - name: remove pod
      #   run: |
      #     rm -rf uniscore-mobile/ios/Pods
      #     rm -rf uniscore-mobile/ios/Podfile.lock
      - name: Cache node_modules
        id: cache-node-modules
        uses: actions/cache@v4
        with:
          path: uniscore-mobile/node_modules
          key: ${{ matrix.platform }}-cache-node-modules-${{ hashFiles('uniscore-mobile/package.json') }}
      # - name: Cache Pods
      #   if: matrix.platform == 'IOS'
      #   id: cache-pods
      #   uses: actions/cache@v4
      #   with:
      #     path: |
      #       uniscore-mobile/ios/Pods
      #       uniscore-mobile/ios/Podfile.lock
      #     key: cache-pods-${{ hashFiles('uniscore-mobile/package.json') }}

      - name: Pod install
        if: ${{ (matrix.platform == 'IOS') }}
        working-directory: uniscore-mobile/ios
        run: pod install
      - name: Setup Node v18
        uses: actions/setup-node@v4
        with:
          node-version: "22.21.1"
      # - name: Cache Xcode DerivedData
      #   if: matrix.platform == 'IOS'
      #   uses: actions/cache@v4
      #   with:
      #     path: |
      #       ~/Library/Developer/Xcode/DerivedData
      #     key: xcode-deriveddata-${{ needs.init.outputs.env }}-${{ hashFiles('uniscore-mobile/ios/Podfile.lock', 'uniscore-mobile/package.json') }}
      #     restore-keys: |
      #       xcode-deriveddata-${{ needs.init.outputs.env }}-
      # - name: Cache node_modules
      #   id: cache-node-modules
      #   uses: actions/cache@v4
      #   with:
      #     path: uniscore-mobile/node_modules
      #     key: ${{ matrix.platform }}-cache-node-modules-${{ hashFiles('uniscore-mobile/package.json') }}
      #     lookup-only: true
      # - name: Run yarn install
      #   # uses: borales/actions-yarn@v5
      #   run: |
      #     cd uniscore-mobile
      #     yarn install --network-concurrency 1

      # - name: Pod install
      #   if: ${{ (matrix.platform == 'IOS') }}
      #   working-directory: uniscore-mobile/ios
      #   run: pod install

      # - name: Cache Xcode build
      #   uses: irgaly/xcode-cache@v1
      #   if: matrix.platform == 'IOS'
      #   with:
      #     key: xcode-cache-deriveddata-${{ needs.init.outputs.env }}-${{ hashFiles('uniscore-mobile/package.json') }}
      #     restore-keys: xcode-cache-deriveddata-${{ needs.init.outputs.env }}-

      - name: Change version and build number
        working-directory: uniscore-mobile
        run: bash .github/scripts/change_version_and_build_number.sh

      - name: Install certificate and provision
        if: matrix.platform == 'IOS'
        working-directory: uniscore-mobile
        run: bash .github/scripts/install_cert_and_provision.sh

      - name: Link Node (/usr/local/bin/node)
        if: matrix.platform == 'IOS'
        run: ln -s $(command -v node) /usr/local/bin/node
      # Build IPA dá»±a theo mÃ´i trÆ°á»ng
      - name: Build IPA Dev Release
        if: ${{matrix.format == 'IPA' && needs.init.outputs.env == 'dev'}}
        working-directory: uniscore-mobile
        run: yarn build:ios-dev-release

      - name: Build IPA Staging Release
        if: ${{matrix.format == 'IPA' && needs.init.outputs.env == 'stag'}}
        working-directory: uniscore-mobile
        run: yarn build:ios-stag-release
      - name: Build IPA Beta Release
        if: ${{matrix.format == 'IPA' && needs.init.outputs.env == 'beta'}}
        working-directory: uniscore-mobile
        run: yarn build:ios-beta-release
      - name: Build IPA Staging Release
        if: ${{matrix.format == 'IPA' && needs.init.outputs.env == 'prod'}}
        working-directory: uniscore-mobile
        run: yarn build:ios-prod-release
      # Build APK dá»±a theo mÃ´i trÆ°á»ng
      - name: Build APK
        if: ${{matrix.format == 'APK' && needs.init.outputs.env == 'dev'}}
        working-directory: uniscore-mobile
        run: yarn build:dev:apk

      - name: Build APK Staging
        if: ${{matrix.format == 'APK' && needs.init.outputs.env == 'stag'}}
        working-directory: uniscore-mobile
        run: yarn build:stag:apk
      - name: Build APK Beta
        if: ${{matrix.format == 'APK' && needs.init.outputs.env == 'beta'}}
        working-directory: uniscore-mobile
        run: yarn build:beta:apk
      - name: Build APK Production
        if: ${{matrix.format == 'APK' && needs.init.outputs.env == 'prod'}}
        working-directory: uniscore-mobile
        run: yarn build:prod:apk
      #  Push to testflight
      - name: Push to testflight dev
        if: ${{ matrix.format == 'IPA' && needs.init.outputs.env == 'dev' }}
        working-directory: uniscore-mobile
        run: bundle exec fastlane ios testflight

      - name: Push to testflight staging
        if: ${{ matrix.format == 'IPA' && needs.init.outputs.env == 'stag' }}
        working-directory: uniscore-mobile
        run: bundle exec fastlane ios testflight_stag

      - name: Push to testflight beta
        if: ${{ matrix.format == 'IPA' && needs.init.outputs.env == 'beta' }}
        working-directory: uniscore-mobile
        run: bundle exec fastlane ios testflight_alpha

      - name: Push to testflight production
        if: ${{ matrix.format == 'IPA' && needs.init.outputs.env == 'prod' }}
        working-directory: uniscore-mobile
        run: bundle exec fastlane ios testflight_prod
      # Deploy apk
      - name: Deploy apk
        if: ${{ matrix.format == 'APK' && needs.init.outputs.env == 'dev' }}
        working-directory: uniscore-mobile
        run: bundle exec fastlane android dev

      - name: Deploy apk
        if: ${{ matrix.format == 'APK' && needs.init.outputs.env == 'stag' }}
        working-directory: uniscore-mobile
        run: bundle exec fastlane android staging

      - name: Deploy apk
        if: ${{ matrix.format == 'APK' && needs.init.outputs.env == 'beta' }}
        working-directory: uniscore-mobile
        run: bundle exec fastlane android beta

      - name: Generate Release Notes & Stats
        if: ${{ success() }}
        working-directory: uniscore-mobile
        run: |
          # 1. Get Commits (last 10 commits or since last tag)
          COMMITS=$(git log -n 10 --pretty=format:"- %s")
          
          # 2. AI Generate Release Notes (3-tier fallback)
          PROMPT="Dá»±a trÃªn danh sÃ¡ch commit sau, hÃ£y viáº¿t má»™t báº£n tÃ³m táº¯t 'CÃ³ gÃ¬ má»›i' ngáº¯n gá»n, vui váº» báº±ng tiáº¿ng Viá»‡t (tá»‘i Ä‘a 5 bullet points, má»—i dÃ²ng tá»‘i Ä‘a 60 kÃ½ tá»±). KhÃ´ng dÃ¹ng markdown phá»©c táº¡p.\n\nCommits:\n$COMMITS"
          jq -n --arg prompt "$PROMPT" '{contents: [{parts: [{text: $prompt}]}]}' > payload_notes.json

          RELEASE_NOTES=$(curl -s -X POST "https://generativelanguage.googleapis.com/v1beta/models/gemini-flash-latest:generateContent?key=$GEMINI_API_KEY" \
            -H "Content-Type: application/json" \
            -d @payload_notes.json | jq -r '.candidates[0].content.parts[0].text // empty')

          if [[ -z "$RELEASE_NOTES" || "$RELEASE_NOTES" == "null" ]]; then
            RELEASE_NOTES=$(curl -s -X POST "https://generativelanguage.googleapis.com/v1beta/models/gemini-flash-lite-latest:generateContent?key=$GEMINI_API_KEY" \
              -H "Content-Type: application/json" \
              -d @payload_notes.json | jq -r '.candidates[0].content.parts[0].text // empty')
          fi

          if [[ -z "$RELEASE_NOTES" || "$RELEASE_NOTES" == "null" ]]; then
            RELEASE_NOTES=$(curl -s -X POST "https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash-lite:generateContent?key=$GEMINI_API_KEY" \
              -H "Content-Type: application/json" \
              -d @payload_notes.json | jq -r '.candidates[0].content.parts[0].text // "Cáº­p nháº­t há»‡ thá»‘ng vÃ  sá»­a lá»—i váº·t."')
          fi
          # Truncate release notes to avoid Telegram limit (max 600 chars)
          echo "${RELEASE_NOTES:0:600}" > ../release_notes.txt

          # 3. Calculate Build Stats
          END_TIME=$(date +%s)
          DURATION=$((END_TIME - JOB_START_TIME))
          MINUTES=$((DURATION / 60))
          SECONDS=$((DURATION % 60))
          echo "${MINUTES}m ${SECONDS}s" > ../build_duration.txt

          # 4. Get File Size
          if [[ "${{ matrix.platform }}" == "ANDROID" ]]; then
            FILE_PATH=$(find android/app/build/outputs -name "*.apk" -o -name "*.aab" | head -n 1)
          else
            FILE_PATH=$(find ios/build -name "*.ipa" | head -n 1)
          fi
          
          if [[ -f "$FILE_PATH" ]]; then
            du -sh "$FILE_PATH" | cut -f1 > ../build_size.txt
          else
            echo "N/A" > ../build_size.txt
          fi

          # 5. AI Build Mood
          MOOD_PROMPT="Dá»±a trÃªn cÃ¡c commit sau, hÃ£y Ä‘áº·t má»™t cÃ¡i tÃªn 'hÃ i hÆ°á»›c, láº§y lá»™i' báº±ng tiáº¿ng Viá»‡t cho báº£n build nÃ y kÃ¨m theo emoji (vÃ­ dá»¥: 'Báº£n build cháº¡y báº±ng niá»m tin ðŸ¤¡' hoáº·c 'SiÃªu nhÃ¢n sá»­a bug ðŸ¦¸â€â™‚ï¸'). Chá»‰ tráº£ vá» cÃ¡i tÃªn, khÃ´ng thÃªm gÃ¬ khÃ¡c.\n\nCommits:\n$COMMITS"
          jq -n --arg prompt "$MOOD_PROMPT" '{contents: [{parts: [{text: $prompt}]}]}' > payload_mood.json
          
          BUILD_MOOD=$(curl -s -X POST "https://generativelanguage.googleapis.com/v1beta/models/gemini-flash-latest:generateContent?key=$GEMINI_API_KEY" \
            -H "Content-Type: application/json" \
            -d @payload_mood.json | jq -r '.candidates[0].content.parts[0].text // "Báº£n build áº©n danh ðŸŽ­"')
          echo "$BUILD_MOOD" > ../build_mood.txt

      # Success notifications moved to 'notify' job below

      - name: Analyze Failure with AI
        if: ${{ failure() }}
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          # 1. Get the failed job logs (limit to last 200 lines)
          LOGS=$(gh run view ${{ github.run_id }} --log-failed | tail -n 200)
          
          # 2. Build Prompt
          PROMPT="HÃ£y phÃ¢n tÃ­ch cÃ¡c log lá»—i GitHub Action sau Ä‘Ã¢y vÃ  cung cáº¥p má»™t báº£n tÃ³m táº¯t ngáº¯n gá»n vá» nhá»¯ng gÃ¬ Ä‘Ã£ sai vÃ  cÃ¡ch kháº¯c phá»¥c báº±ng tiáº¿ng Viá»‡t. Giá»¯ ná»™i dung dÆ°á»›i 200 tá»«. Tráº£ vá» káº¿t quáº£ dÆ°á»›i dáº¡ng text thuáº§n tÃºy, khÃ´ng dÃ¹ng markdown quÃ¡ phá»©c táº¡p.\n\nLog:\n$LOGS"
          
          # 3. Build JSON payload using jq
          jq -n --arg prompt "$PROMPT" '{contents: [{parts: [{text: $prompt}]}]}' > payload_fail.json

          # 4. Send to Gemini for analysis (3-tier fallback)
          ANALYSIS=$(curl -s -X POST "https://generativelanguage.googleapis.com/v1beta/models/gemini-flash-latest:generateContent?key=$GEMINI_API_KEY" \
            -H "Content-Type: application/json" \
            -d @payload_fail.json | jq -r '.candidates[0].content.parts[0].text // empty')

          if [[ -z "$ANALYSIS" || "$ANALYSIS" == "null" ]]; then
            ANALYSIS=$(curl -s -X POST "https://generativelanguage.googleapis.com/v1beta/models/gemini-flash-lite-latest:generateContent?key=$GEMINI_API_KEY" \
              -H "Content-Type: application/json" \
              -d @payload_fail.json | jq -r '.candidates[0].content.parts[0].text // empty')
          fi

          if [[ -z "$ANALYSIS" || "$ANALYSIS" == "null" ]]; then
            ANALYSIS=$(curl -s -X POST "https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash-lite:generateContent?key=$GEMINI_API_KEY" \
              -H "Content-Type: application/json" \
              -d @payload_fail.json | jq -r '.candidates[0].content.parts[0].text // "KhÃ´ng thá»ƒ phÃ¢n tÃ­ch lá»—i lÃºc nÃ y."')
          fi
          
          # 5. Save analysis to a file
          echo "$ANALYSIS" > ai_analysis.txt

      - name: Send telegram message failure
        if: ${{ failure() }}
        uses: UniscoreDev/macos-telegram-action@main
        with:
          type: topic
          message: |
            ðŸ’¥ - [${{ matrix.format }}] Tháº¥t báº¡i rá»“i Ä‘áº¡i ca! Check láº¡i nhÃ©: ${{ needs.init.outputs.message-information }}
            
            ðŸ” **PhÃ¢n tÃ­ch AI:**
            $(cat ai_analysis.txt 2>/dev/null || echo "KhÃ´ng cÃ³ phÃ¢n tÃ­ch nÃ o.")

  notify:
    name: Send Success Notification
    runs-on: ubuntu-latest
    needs: [init, deploy]
    if: ${{ success() }}
    steps:
      - name: Clone GitLab repository
        run: |
          git clone https://oauth2:$GITLAB_TOKEN@gitlab.com/unity1185445/uniscore-mobile.git
          cd uniscore-mobile
          git checkout $REF_NAME

      - name: Generate Release Notes & Build Message
        id: generate-message
        working-directory: uniscore-mobile
        run: |
          # 1. Get Commits (last 10 commits)
          COMMITS=$(git log -n 10 --pretty=format:"- %s")
          
          # 2. AI Generate Release Notes (3-tier fallback) - max 400 chars
          PROMPT="Dá»±a trÃªn danh sÃ¡ch commit sau, hÃ£y viáº¿t má»™t báº£n tÃ³m táº¯t 'CÃ³ gÃ¬ má»›i' ngáº¯n gá»n, vui váº» báº±ng tiáº¿ng Viá»‡t (tá»‘i Ä‘a 4 bullet points, má»—i dÃ²ng tá»‘i Ä‘a 50 kÃ½ tá»±). KhÃ´ng dÃ¹ng markdown phá»©c táº¡p, khÃ´ng Ä‘Ã¡nh sá»‘.\n\nCommits:\n$COMMITS"
          jq -n --arg prompt "$PROMPT" '{contents: [{parts: [{text: $prompt}]}]}' > payload_notes.json

          RELEASE_NOTES=$(curl -s -X POST "https://generativelanguage.googleapis.com/v1beta/models/gemini-flash-latest:generateContent?key=$GEMINI_API_KEY" \
            -H "Content-Type: application/json" \
            -d @payload_notes.json | jq -r '.candidates[0].content.parts[0].text // empty')

          if [[ -z "$RELEASE_NOTES" || "$RELEASE_NOTES" == "null" ]]; then
            RELEASE_NOTES=$(curl -s -X POST "https://generativelanguage.googleapis.com/v1beta/models/gemini-flash-lite-latest:generateContent?key=$GEMINI_API_KEY" \
              -H "Content-Type: application/json" \
              -d @payload_notes.json | jq -r '.candidates[0].content.parts[0].text // empty')
          fi

          if [[ -z "$RELEASE_NOTES" || "$RELEASE_NOTES" == "null" ]]; then
            RELEASE_NOTES=$(curl -s -X POST "https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash-lite:generateContent?key=$GEMINI_API_KEY" \
              -H "Content-Type: application/json" \
              -d @payload_notes.json | jq -r '.candidates[0].content.parts[0].text // "- Cáº­p nháº­t há»‡ thá»‘ng vÃ  sá»­a lá»—i."')
          fi
          
          # Truncate release notes (max 400 chars to leave room for other content)
          RELEASE_NOTES="${RELEASE_NOTES:0:400}"

          # 3. AI Build Mood (max 60 chars)
          MOOD_PROMPT="Dá»±a trÃªn cÃ¡c commit sau, hÃ£y Ä‘áº·t má»™t cÃ¡i tÃªn 'hÃ i hÆ°á»›c, láº§y lá»™i' báº±ng tiáº¿ng Viá»‡t cho báº£n build nÃ y kÃ¨m theo emoji (vÃ­ dá»¥: 'Báº£n build cháº¡y báº±ng niá»m tin ðŸ¤¡'). Chá»‰ tráº£ vá» cÃ¡i tÃªn, tá»‘i Ä‘a 50 kÃ½ tá»±.\n\nCommits:\n$COMMITS"
          jq -n --arg prompt "$MOOD_PROMPT" '{contents: [{parts: [{text: $prompt}]}]}' > payload_mood.json
          
          BUILD_MOOD=$(curl -s -X POST "https://generativelanguage.googleapis.com/v1beta/models/gemini-flash-latest:generateContent?key=$GEMINI_API_KEY" \
            -H "Content-Type: application/json" \
            -d @payload_mood.json | jq -r '.candidates[0].content.parts[0].text // "Báº£n build áº©n danh ðŸŽ­"')
          BUILD_MOOD="${BUILD_MOOD:0:60}"

          # 4. Build complete message (ensure all static parts are always present)
          VERSION_INFO="${{ needs.init.outputs.message-information }}"
          
          # Construct the full message with proper escaping for multiline
          {
            echo "TELEGRAM_MESSAGE<<EOF"
            echo "ðŸš€ **${BUILD_MOOD}**"
            echo ""
            echo "âœ… **ÄÃƒ Sáº´N SÃ€NG TRÃŠN Cáº¢ iOS VÃ€ ANDROID!**"
            echo "ðŸ“± iOS: TestFlight"
            echo "ðŸ¤– Android: App Distribution"
            echo ""
            echo "ðŸ“¦ **PhiÃªn báº£n:** ${VERSION_INFO}"
            echo ""
            echo "ðŸ“ **CÃ³ gÃ¬ má»›i trong phiÃªn báº£n nÃ y:**"
            echo "${RELEASE_NOTES}"
            echo "EOF"
          } >> $GITHUB_ENV

      - name: Send combined Telegram notification
        uses: UniscoreDev/macos-telegram-action@main
        with:
          type: topic
          message: ${{ env.TELEGRAM_MESSAGE }}
